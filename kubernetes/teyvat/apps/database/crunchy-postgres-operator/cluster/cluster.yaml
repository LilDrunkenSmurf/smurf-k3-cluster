---
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: &name postgres
spec:
  postgresVersion: 16
  patroni: # turn on sync writes to at least 1 other replica
    dynamicConfiguration:
      synchronous_mode: true
      postgresql:
        synchronous_commit: "on"
  service:
    type: LoadBalancer
  instances:
    - name: postgres
      metadata:
        labels:
          app.kubernetes.io/name: crunchy-postgres
      replicas: &replica 3
      dataVolumeClaimSpec:
        storageClassName: local-hostpath
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 20Gi
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: "kubernetes.io/hostname"
          whenUnsatisfiable: "DoNotSchedule"
          labelSelector:
            matchLabels:
              postgres-operator.crunchydata.com/data: postgres
  users:
    - name: "atuin"
      databases: ["atuin"]
    - name: "authentik"
      databases: ["authentik"]
    - name: "bazarr"
      databases: ["bazarr"]
    - name: "gatus"
      databases: ["gatus"]
    - name: "grafana"
      databases: ["grafana"]
    - name: "paperless"
      databases: ["paperless"]
    - name: "postgres"
    - name: "prowlarr"
      databases: ["prowlarr_main, prowlarr_log"]
    - name: "radarr"
      databases: ["radarr_main, radarr_log"]
    - name: "readarr"
      databases: ["readarr_cache, readarr_main, readarr_log"]
    - name: "sonarr"
      databases: ["sonarr_main, sonarr_log"]
  backups:
    pgbackrest:
      configuration: &backupConfig
        - secret:
            name: crunchy-postgres
      global: &backupFlag
        archive-timeout: "60"
        compress-type: "bz2"
        compress-level: "9"
        delta: "y"
        repo1-retention-full-type: "time"
        repo1-retention-full: "14"
        repo1-retention-diff: "30"
        repo1-path: "/crunchy-pgo"
        repo1-s3-uri-style: path
        repo2-bundle: "y"
        repo2-block: "y"
        repo2-path: "/crunchy-pgo"
        repo2-s3-uri-style: "path"
        repo2-retention-full-type: "time"
        repo2-retention-full: "2"
        repo2-retention-diff: "7"
        repo2-cipher-type: "aes-256-cbc"
        repo3-bundle: "y"
        repo3-block: "y"
        repo3-s3-uri-style: "path"
        repo3-retention-full-type: "time"
        repo3-retention-full: "5"
        repo3-retention-diff: "30"
        repo3-cipher-type: "aes-256-cbc"
        archive-push-queue-max: 4GiB
      manual:
        repoName: repo1
        options:
          - --type=full
      metadata:
        labels:
          app.kubernetes.io/name: crunchy-postgres-backup
      repos:
        - name: repo1 # Minio
          s3: &minio
            bucket: "postgresql"
            endpoint: "s3.${SECRET_DOMAIN}"
            region: "ca-west-1"
          schedules:
            full: "0 1 * * 0" # Sunday at 01:00
            differential: "0 1 * * 1-6" # Mon-Sat at 01:00
            incremental: "0 2-23 * * *" # Every hour except 01:00
        - name: "repo2" # Cloudflare R2
          s3: &r2
            bucket: "postgresql"
            endpoint: "${SECRET_PGBACKREST_WAL_R2_ENDPOINT}"
            region: "ca-west-1"
          schedules:
            full: "0 2 * * 0" # Sunday at 02:00
            differential: "0 2 * * 1-6" # Mon-Sat at 02:00
  # dataSource:
  #   pgbackrest:
  #     stanza: "db"
  #     configuration: *backupConfig
  #     global: *backupFlag
  #     repo:
  #       name: "repo1"
  #       s3: *minio
  proxy:
    pgBouncer:
      port: 5432
      replicas: *replica
      # config:
      #   global:
      #     pool_mode: "transaction"
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: "kubernetes.io/hostname"
          whenUnsatisfiable: "DoNotSchedule"
          labelSelector:
            matchLabels:
              postgres-operator.crunchydata.com/cluster: *name
              postgres-operator.crunchydata.com/role: "pgbouncer"
  metadata:
    annotations:
      replicator.v1.mittwald.de/replication-allowed: "true"
      replicator.v1.mittwald.de/replication-allowed-namespaces: "*"
